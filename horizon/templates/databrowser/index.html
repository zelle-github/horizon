{% extends "base.html" %}
{% load static from staticfiles %}

{% block content1header %}
<link rel="stylesheet" href="{% static "plugins/ionslider/ion.rangeSlider.css" %}">
<link rel="stylesheet" href="{% static "plugins/ionslider/ion.rangeSlider.skinNice.css" %}">

<h1>
  Data-Browser
  <small>beta</small>
</h1>
<ol class="breadcrumb">
  <li><a href="#"><i class="fa fa-dashboard"></i> Level</a></li>
  <li class="active">Here</li>
</ol>
{% endblock %}

{% block content1 %}
<link rel="stylesheet" href="{% static "cornerstone.css" %}">

<section class="content">
  <div class="row">
    <div class="col-md-7">
{% for datasetid, dataset_dict in datasets.iteritems %}
      <div class="box box-primary collapsed-box box-solid">
          <div class="box-header with-border">
            <h3 class="box-title">{{dataset_dict.dataset.dataset_name}}</h3>
            <div class="box-tools pull-right">
              <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
            </div>
          </div><!-- /.box-header -->
          <div class="box-body table-responsive no-padding">
            <table id="table_dataset_{{datasetid}}" class="table table-hover">
              <thead>
                <tr>
                  <th>PatientID</th>
                  <th>Studies</th>
                </tr>
              </thead>
              <tbody>
{% for patientid, patient_dict in dataset_dict.patients.iteritems %}
                 <tr>
                  <td>{{patient_dict.patient.patient_dicomid}}</td>
                  <td>    
                    <div class="box-group" id="accordion_main_{{patientid}}">
                      <div class="panel box box-danger">
                      
                        <div class="box-header with-border">
                          <h4 class="box-title">
                            <a data-toggle="collapse" data-parent="#accordion_main_{{patientid}}" href="#collapse_main_{{patientid}}">
                              Studies
                            </a>
                          </h4>
                        </div>
                        <div id="collapse_main_{{patientid}}" class="panel-collapse collapse">
                          <div class="box-body">
                            <div class="box-group" id="accordion_studies_{{patientid}}">  
{% for studyid, study_dict in patient_dict.studies.iteritems %}                            
                              <div class="panel box box-danger">
                                <div class="box-header with-border">
                                  <h4 class="box-title">
                                    <a data-toggle="collapse" data-parent="#accordion_studies_{{patientid}}" href="#collapse_study_{{studyid}}">
                                      {{study_dict.study.study_name}}
                                    </a>
                                  </h4>
                                </div>
                                <div id="collapse_study_{{studyid}}" class="panel-collapse collapse">
                                  <div class="box-body">
                                  
{% for imageid, image_dict in study_dict.images.iteritems %}
<table id="image_table_{{imageid}}" class="table table-bordered table-striped">
  <thead>
    <tr>
      <th></th>
{% for segmentation in image_dict.segmentations %}      
      <th>{{segmentation.segmentation_name}}</th>
{% endfor %}
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>{{image_dict.image.image_name}}</td>
{% for segmentation in image_dict.segmentations %} 
      <td>{{segmentation.segmentation_validationstatus}}</td>
{% endfor %}
    </tr>
  </tbody>
</table>
<br>
{% endfor %}
                   
                                  </div>
                                </div>
                              </div>  
{% endfor %}                                                      
                            </div> 
                          </div> 
                        </div>
                        
                      </div> 
                    </div>
                    
                  </td>
                </tr>
{% endfor %}                              
              </tbody>
            </table>
          </div><!-- /.box-body -->
          <div class="box-tools">
            <div class="input-group input-group-sm" style="width: 150px;">
              <input type="text" name="table_search" class="form-control pull-right" placeholder="Search">

              <div class="input-group-btn">
                <button type="submit" class="btn btn-default"><i class="fa fa-search"></i></button>
              </div>
            </div>
          </div>
        </div><!-- /.box -->
      </div><!-- /.col -->
      
      <div class="col-md-5">
        <div class="box box-primary box-solid">
          <div class="box-header with-border">
            <h3 class="box-title">Cornerstone Viewer</h3>
            <div class="box-tools pull-right">
              <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
            </div>
          </div>
          <div class="box-body">
            <div class="row margin" style="text-align:center">
              <div class="btn-group">
                <button id="invert" class="btn btn-default">Toggle Invert</button>
                <button id="interpolation" class="btn btn-default">Toggle Interpolation</button>
                <button id="hflip" class="btn btn-default">Horizontal Flip</button>
                <button id="vflip" class="btn btn-default">Vertical Flip</button>
              </div>
            </div>
            <div class="row margin" style="text-align:center">
              <div id="dicomImageWrapper" style="margin:auto;width:512px;height:512px;position:relative;color:white;"
                   class="cornerstone-enabled-image"
                   oncontextmenu="return false"
                   unselectable='on'
                   onselectstart='return false;'
                   onmousedown='return false;'>
                  <div id="dicomImage" oncontextmenu="return false"
                       style="width:512px;height:512px;top:0px;left:0px; position:absolute">
                  </div>
                  <div id="topleft" style="position: absolute;top:0px; left:0px">
                      Patient:
                  </div>
                  <div id="topright" style="position: absolute;top:0px; right:0px">
                      Image:
                  </div>
                  <div id="bottomright" style="position: absolute;bottom:0px; right:0px">
                      Zoom:
                  </div>
                  <div id="bottomleft" style="position: absolute;bottom:0px; left:0px">
                      WW/WC:
                  </div>
                  <div><span id="coords"></span></div> 
              </div>
              <div class="col-sm-12">
                <input id="range_5" type="text" name="range_5" value="">
              </div>
            </div>
          </div><!-- /.box-body -->
        </div><!-- /.box -->
{% endfor %}         
      </div><!-- /.col -->
    </div><!-- /.row -->  
  </section><!-- /.content -->
{% endblock %}

{% block scripts %}
<script src="{% static "cornerstone.js" %}"></script>
<script src="{% static "exampleImageIdLoader.js" %}"></script>
<script src="{% static "plugins/ionslider/ion.rangeSlider.min.js" %}"></script>
<script>
    $(document).ready(function() {

        var imageIds = [
            'example://1',
            'example://2'];
        var currentImageIndex = 0;


        // updates the image display
        function updateTheImage(imageIndex) {
            return cornerstone.loadAndCacheImage(imageIds[imageIndex]).then(function(image) {
                currentImageIndex = imageIndex;
                var viewport = cornerstone.getViewport(element);
                cornerstone.displayImage(element, image, viewport);
            });
        }

        // image enable the element
        var element = $('#dicomImage').get(0);
        cornerstone.enable(element);

        // set event handlers
        function onImageRendered(e, eventData) {
           $('#topright').text("Render Time:" + eventData.renderTimeInMs + " ms");
        }
        $(element).on("CornerstoneImageRendered", onImageRendered);

        // setup handlers before we display the image
        function onImageRendered(e, eventData) {
            // set the canvas context to the image coordinate system
            cornerstone.setToPixelCoordinateSystem(eventData.enabledElement, eventData.canvasContext);

            // NOTE: The coordinate system of the canvas is in image pixel space.  Drawing
            // to location 0,0 will be the top left of the image and rows,columns is the bottom
            // right.
            var context = eventData.canvasContext;
            context.beginPath();
            context.strokeStyle = 'white';
            context.lineWidth = .5;
            context.rect(128, 90, 50, 60);
            context.stroke();
            context.fillStyle = "white";
            context.font = "6px Arial";
            context.fillText("Tumor Here", 128, 85);

            $('#topright').text("Render Time:" + cornerstone.lastRenderTimeInMs + " ms");
            $('#bottomleft').text("WW/WL:" + Math.round(eventData.viewport.voi.windowWidth) + "/" + Math.round(eventData.viewport.voi.windowCenter));
            $('#bottomright').text("Zoom:" + eventData.viewport.scale.toFixed(2));

        }
        $(element).on("CornerstoneImageRendered", onImageRendered);

        // load and display the image
        var imagePromise = updateTheImage(0);

        // add handlers for mouse events once the image is loaded.
        imagePromise.then(function() {
            viewport = cornerstone.getViewport(element);
            $('#bottomright').text("Zoom: " + viewport.scale.toFixed(2) + "x");
            $('#bottomleft').text("WW/WC:" + Math.round(viewport.voi.windowWidth) + "/" + Math.round(viewport.voi.windowCenter));

            // add event handlers to pan image on mouse move
            $('#dicomImage').mousedown(function (e) {
                var lastX = e.pageX;
                var lastY = e.pageY;

                var mouseButton = e.which;

                $(document).mousemove(function (e) {
                    var deltaX = e.pageX - lastX,
                            deltaY = e.pageY - lastY;
                    lastX = e.pageX;
                    lastY = e.pageY;

                    if (mouseButton == 1) {
                        var viewport = cornerstone.getViewport(element);
                        viewport.voi.windowWidth += (deltaX / viewport.scale);
                        viewport.voi.windowCenter += (deltaY / viewport.scale);
                        cornerstone.setViewport(element, viewport);
                        $('#bottomleft').text("WW/WL:" + Math.round(viewport.voi.windowWidth) + "/" + Math.round(viewport.voi.windowCenter));
                    }
                    else if (mouseButton == 2) {
                        var viewport = cornerstone.getViewport(element);
                        viewport.translation.x += (deltaX / viewport.scale);
                        viewport.translation.y += (deltaY / viewport.scale);
                        cornerstone.setViewport(element, viewport);
                    }
                    else if (mouseButton == 3) {
                        var viewport = cornerstone.getViewport(element);
                        viewport.scale += (deltaY / 100);
                        cornerstone.setViewport(element, viewport);
                        $('#bottomright').text("Zoom: " + viewport.scale.toFixed(2) + "x");
                    }
                });

                $(document).mouseup(function (e) {
                    $(document).unbind('mousemove');
                    $(document).unbind('mouseup');
                });
            });

            $('#dicomImage').on('mousewheel DOMMouseScroll', function (e) {
                // Firefox e.originalEvent.detail > 0 scroll back, < 0 scroll forward
                // chrome/safari e.originalEvent.wheelDelta < 0 scroll back, > 0 scroll forward
                if (e.originalEvent.wheelDelta < 0 || e.originalEvent.detail > 0) {
                    if (currentImageIndex == 0) {
                        updateTheImage(1);
                    }
                } else {
                    if (currentImageIndex == 1) {
                        updateTheImage(0);
                    }
                }
                //prevent page fom scrolling
                return false;
            });

            $('#invert').click(function (e) {
                var viewport = cornerstone.getViewport(element);
                if (viewport.invert === true) {
                    viewport.invert = false;
                } else {
                    viewport.invert = true;
                }
                cornerstone.setViewport(element, viewport);
            });

            $('#interpolation').click(function (e) {
                var viewport = cornerstone.getViewport(element);
                if (viewport.pixelReplication === true) {
                    viewport.pixelReplication = false;
                } else {
                    viewport.pixelReplication = true;
                }
                cornerstone.setViewport(element, viewport);
            });
            $('#hflip').click(function (e) {
                var viewport = cornerstone.getViewport(element);
                viewport.hflip = !viewport.hflip;
                cornerstone.setViewport(element, viewport);
            });
            $('#vflip').click(function (e) {
                var viewport = cornerstone.getViewport(element);
                viewport.vflip = !viewport.vflip;
                cornerstone.setViewport(element, viewport);
            });
            $(element).mousemove(function(event)
            {
                var pixelCoords = cornerstone.pageToPixel(element, event.pageX, event.pageY);
                var x = event.pageX;
                var y = event.pageY;
                $('#coords').text("pageX=" + event.pageX + ", pageY=" + event.pageY + ", pixelX=" + pixelCoords.x + ", pixelY=" + pixelCoords.y);
            });
        });
    });
</script>

<script>
  $(function () {
    /* ION SLIDER */
    $("#range_5").ionRangeSlider({
      min: 0,
      max: 10,
      type: 'single',
      step: 0.1,
      postfix: " mm",
      prettify: false,
      hasGrid: true
    });
  });
</script>
  
{% endblock %} 